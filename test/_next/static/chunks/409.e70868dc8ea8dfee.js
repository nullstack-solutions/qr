(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[409],{67:function(){},2061:function(){},4570:function(e,r,n){"use strict";n.r(r),n.d(r,{BatchGenerator:function(){return g}});var l=n(3827),t=n(4090),a=n(6491),s=n.n(a),o=n(4323),c=n(6480),i=n.n(c),u=n(4113),d=n(9785);let h={format:"png",size:600,errorCorrection:"H",margin:4,foreground:"#0b1220",background:"#ffffff",chunk:250};function p(e){return e.toString().trim().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").slice(0,40)||"entry"}async function m(e){return new Promise((r,n)=>{s().parse(e,{header:!0,skipEmptyLines:!0,dynamicTyping:!1,complete:e=>{r(e.data.filter(Boolean))},error:n})})}async function x(e){let r=await e.arrayBuffer(),n=(0,o.ij)(r,{type:"array"}),l=n.Sheets[n.SheetNames[0]];return o.P6.sheet_to_json(l,{raw:!1,defval:""})}function g(){let e=(0,t.useRef)(null),[r,a]=(0,t.useState)([]),[s,o]=(0,t.useState)(null),[c,g]=(0,t.useState)(null),[j,v]=(0,t.useState)(null),[b,f]=(0,t.useState)(null),{value:y,setValue:C}=(0,d.L)("batch",h);(0,t.useEffect)(()=>{let r=new Worker(n.tu(new URL(n.p+n.u(194),n.b)));return e.current=r,r.onmessage=e=>{let r=e.data;if(r.error){v(r.error),g(null);return}if(void 0!==r.progress&&g({processed:r.processed,total:r.total,progress:r.progress}),r.done){let e=new Blob([r.buffer],{type:"application/zip"}),n=URL.createObjectURL(e);f(e=>(e&&URL.revokeObjectURL(e),n)),g(null)}},()=>{r.terminate()}},[]),(0,t.useEffect)(()=>()=>{b&&URL.revokeObjectURL(b)},[b]);let k=(0,t.useCallback)(async e=>{v(null),f(null),g(null),o(e.name);let r=[];try{r=e.name.toLowerCase().endsWith(".csv")?await m(e):await x(e)}catch(e){var n;v(null!==(n=null==e?void 0:e.message)&&void 0!==n?n:"Не удалось прочитать файл"),a([]);return}a(r.map((e,r)=>{var n,l,t,a,s,o;let c=(null!==(l=null!==(n=e.type)&&void 0!==n?n:e.Type)&&void 0!==l?l:"text").toString().trim().toLowerCase(),i=u.u.some(e=>e.type===c)?c:null,d=[],h="";if(i){let r=(0,u.x)(i),n={};for(let l of r.fields){let r=null!==(s=null!==(a=null!==(t=e[l.name])&&void 0!==t?t:e[l.name.toUpperCase()])&&void 0!==a?a:e[l.label])&&void 0!==s?s:"";if(n[l.name]=null!==(o=null==r?void 0:r.toString())&&void 0!==o?o:"",l.required&&!n[l.name].trim()&&d.push("Поле ".concat(l.label," обязательно")),l.validate){let e=l.validate(n[l.name],n);e&&d.push("".concat(l.label,": ").concat(e))}}(h=r.buildPayload(n))||d.push("Не удалось построить полезную нагрузку"),new TextEncoder().encode(h).length>2953&&d.push("Превышен лимит байт")}else d.push("Неизвестный тип: ".concat(e.type));let m=e.slug||e.SLUG||e.filename||e.name||Object.values(e)[1]||"row-".concat(r+1),x=p(null!=m?m:"row-".concat(r+1));return{index:r+1,type:i,slug:x,payload:h,errors:d,raw:e}}))},[]),N=(0,t.useMemo)(()=>r.slice(0,20),[r]),w=(0,t.useMemo)(()=>r.filter(e=>0===e.errors.length&&e.type),[r]),S=(0,t.useCallback)(()=>{if(!e.current)return;if(0===w.length){v("Нет валидных строк для генерации");return}let r=crypto.randomUUID();e.current.postMessage({id:r,items:w.map(e=>({index:e.index,type:e.type,payload:e.payload,slug:e.slug})),format:y.format,options:{errorCorrection:y.errorCorrection,margin:y.margin,size:y.size,foreground:y.foreground,background:y.background,chunk:y.chunk}}),g({processed:0,total:w.length,progress:0})},[y,w]),L=(0,t.useCallback)(()=>{if(!b)return;let e=document.createElement("a");e.href=b;let r=new Date().toISOString().slice(0,10),n=s?p(s.replace(/\.[^.]+$/,"")):"qr-batch";e.download="".concat(n,"-").concat(r,".zip"),document.body.appendChild(e),e.click(),document.body.removeChild(e)},[b,s]),_=(0,t.useCallback)(e=>{C(r=>({...r,...e}))},[C]);return(0,l.jsxs)("section",{className:"card",children:[(0,l.jsxs)("header",{className:"card__header",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("h2",{children:"Массовая генерация"}),(0,l.jsx)("p",{children:"Импорт CSV/XLSX, предпросмотр и ZIP c PNG/SVG."})]}),(0,l.jsxs)("span",{className:"badge",children:["10k строк, чанки ",y.chunk]})]}),(0,l.jsxs)("div",{className:"batch",children:[(0,l.jsxs)("div",{className:"batch__left",children:[(0,l.jsxs)("label",{className:"dropzone",children:[(0,l.jsx)("input",{type:"file",accept:".csv,.xlsx,.xls",onChange:e=>{var r;let n=null===(r=e.target.files)||void 0===r?void 0:r[0];n&&k(n)}}),(0,l.jsx)("strong",{children:"Загрузите CSV или XLSX"}),(0,l.jsx)("span",{children:"Столбцы: type, поля формы, slug (опционально)"}),s?(0,l.jsx)("em",{children:s}):null]}),(0,l.jsxs)("div",{className:"batch__options",children:[(0,l.jsxs)("label",{children:["Формат",(0,l.jsxs)("select",{value:y.format,onChange:e=>_({format:e.target.value}),children:[(0,l.jsx)("option",{value:"png",children:"PNG"}),(0,l.jsx)("option",{value:"svg",children:"SVG"})]})]}),(0,l.jsxs)("label",{children:["Размер",(0,l.jsx)("input",{type:"number",min:256,max:1024,value:y.size,onChange:e=>_({size:Number(e.target.value)})})]}),(0,l.jsxs)("label",{children:["Коррекция",(0,l.jsxs)("select",{value:y.errorCorrection,onChange:e=>_({errorCorrection:e.target.value}),children:[(0,l.jsx)("option",{value:"L",children:"L"}),(0,l.jsx)("option",{value:"M",children:"M"}),(0,l.jsx)("option",{value:"Q",children:"Q"}),(0,l.jsx)("option",{value:"H",children:"H"})]})]}),(0,l.jsxs)("label",{children:["Отступ (модули)",(0,l.jsx)("input",{type:"number",min:0,max:8,value:y.margin,onChange:e=>_({margin:Number(e.target.value)})})]}),(0,l.jsxs)("label",{children:["Цвет точек",(0,l.jsx)("input",{type:"color",value:y.foreground,onChange:e=>_({foreground:e.target.value})})]}),(0,l.jsxs)("label",{children:["Цвет фона",(0,l.jsx)("input",{type:"color",value:y.background,onChange:e=>_({background:e.target.value})})]}),(0,l.jsxs)("label",{children:["Размер чанка",(0,l.jsx)("input",{type:"number",min:50,max:1e3,value:y.chunk,onChange:e=>_({chunk:Number(e.target.value)})})]})]}),(0,l.jsxs)("button",{type:"button",className:"primary",onClick:S,disabled:null!==c,children:["Сформировать ZIP (",w.length,")"]}),c?(0,l.jsxs)("p",{className:"progress",children:["Обработано ",c.processed,"/",c.total," (",Math.round(100*c.progress),"%)"]}):null,b?(0,l.jsx)("button",{type:"button",className:"secondary",onClick:L,children:"Скачать ZIP"}):null,j?(0,l.jsx)("p",{className:"error-text",children:j}):null]}),(0,l.jsxs)("div",{className:"batch__preview",children:[(0,l.jsxs)("h3",{children:["Предпросмотр первых ",N.length," строк"]}),0===N.length?(0,l.jsx)("p",{className:"hint",children:"Загрузите файл чтобы увидеть содержимое"}):(0,l.jsxs)("table",{children:[(0,l.jsx)("thead",{children:(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{children:"#"}),(0,l.jsx)("th",{children:"Тип"}),(0,l.jsx)("th",{children:"Slug"}),(0,l.jsx)("th",{children:"Ошибки"})]})}),(0,l.jsx)("tbody",{children:N.map(e=>{var r;return(0,l.jsxs)("tr",{className:i()({error:e.errors.length>0}),children:[(0,l.jsx)("td",{children:e.index}),(0,l.jsx)("td",{children:null!==(r=e.type)&&void 0!==r?r:e.raw.type}),(0,l.jsx)("td",{children:e.slug}),(0,l.jsx)("td",{children:e.errors.length>0?e.errors.join(", "):(0,l.jsx)("span",{className:"ok",children:"Готово"})})]},e.index)})})]})]})]})]})}}}]);