"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[996],{996:function(e,t,n){n.r(t),n.d(t,{Scanner:function(){return r}});var l=n(3827),a=n(4090),i=n(1735);function r(){let e=(0,a.useRef)(null),[t,n]=(0,a.useState)(!1),[r,s]=(0,a.useState)([]),[c,d]=(0,a.useState)(null),u=(0,a.useRef)(null),o=(0,a.useRef)(null),[v,m]=(0,a.useState)(null),p=(0,a.useMemo)(()=>{var e,t,n,l;let a=null===(t=window.Telegram)||void 0===t?void 0:null===(e=t.WebApp)||void 0===e?void 0:e.platform;if(a&&["ios","android","android_x"].includes(a))return!0;let i=null!==(l=null===(n=window.navigator)||void 0===n?void 0:n.userAgent)&&void 0!==l?l:"";return/iphone|ipad|ipod|android/i.test(i)},[]),h=(0,a.useCallback)(()=>{var e;(null===(e=u.current)||void 0===e?void 0:e.srcObject)&&u.current.srcObject.getTracks().forEach(e=>e.stop()),u.current&&(u.current.srcObject=null),n(!1)},[]);(0,a.useEffect)(()=>(e.current=new i.VJ,()=>{h()}),[h]),(0,a.useEffect)(()=>{let e=!1;return async function(){var t;if("undefined"==typeof navigator||!(null===(t=navigator.mediaDevices)||void 0===t?void 0:t.enumerateDevices)){m(!1);return}try{let t=await navigator.mediaDevices.enumerateDevices();e||m(t.some(e=>"videoinput"===e.kind))}catch(t){e||m(!1)}}(),()=>{e=!0}},[]);let f=(0,a.useCallback)(async function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"file";if(!e.current)return;d(null);let l=URL.createObjectURL(t);try{let t=await e.current.decodeFromImageUrl(l);s(e=>[{text:t.getText(),timestamp:Date.now(),source:n},...e].slice(0,20))}catch(e){var a;d(null!==(a=null==e?void 0:e.message)&&void 0!==a?a:"Файл не содержит QR-код")}finally{URL.revokeObjectURL(l)}},[]),x=(0,a.useCallback)(async()=>{var t,l,a,r;if(p){let e=document.createElement("input");e.type="file",e.accept="image/*",e.setAttribute("capture","environment"),e.style.display="none";let t=()=>{e.value="",e.parentNode&&e.parentNode.removeChild(e)};e.addEventListener("change",e=>{var n;let l=null===(n=e.target.files)||void 0===n?void 0:n[0];l&&f(l,"camera"),t()}),document.body.appendChild(e),e.click();return}if(e.current&&u.current){if(!1===v){d("Камера не найдена. Загрузите изображение."),null===(t=o.current)||void 0===t||t.click();return}d(null);try{let t=await i.VJ.listVideoInputDevices(),r=null!==(a=null===(l=t[0])||void 0===l?void 0:l.deviceId)&&void 0!==a?a:void 0;n(!0),await e.current.decodeFromVideoDevice(r,u.current,(e,t)=>{if(e&&s(t=>[{text:e.getText(),timestamp:Date.now(),source:"camera"},...t].slice(0,20)),t&&"NotFoundException"!==t.name){var n;d(null!==(n=t.message)&&void 0!==n?n:"Ошибка сканирования")}})}catch(e){d(null!==(r=null==e?void 0:e.message)&&void 0!==r?r:"Не удалось получить доступ к камере"),n(!1)}}},[f,v,p]);return(0,l.jsxs)("section",{className:"card",children:[(0,l.jsx)("header",{className:"card__header",children:(0,l.jsxs)("div",{children:[(0,l.jsx)("h2",{children:"Клиентский сканер"}),(0,l.jsx)("p",{children:"Камера или изображение, всё локально."})]})}),(0,l.jsxs)("div",{className:"scanner",children:[(0,l.jsxs)("div",{className:"scanner__video",children:[(0,l.jsx)("video",{ref:u,playsInline:!0,muted:!0,autoPlay:!0,className:t?"active":""}),(0,l.jsxs)("div",{className:"scanner__controls",children:[t?(0,l.jsx)("button",{type:"button",onClick:h,className:"secondary",children:"Остановить"}):(0,l.jsx)("button",{type:"button",onClick:x,className:"primary",children:"Включить камеру"}),(0,l.jsxs)("label",{className:"upload",children:[(0,l.jsx)("input",{ref:o,type:"file",accept:"image/png,image/jpeg,image/webp,image/svg+xml",onChange:e=>{var t;let n=null===(t=e.target.files)||void 0===t?void 0:t[0];n&&f(n)}}),(0,l.jsx)("span",{children:"Загрузить изображение"})]})]}),c?(0,l.jsx)("p",{className:"error-text",children:c}):null]}),(0,l.jsxs)("div",{className:"scanner__results",children:[(0,l.jsx)("h3",{children:"Последние результаты"}),0===r.length?(0,l.jsx)("p",{className:"hint",children:"Пока нет данных"}):(0,l.jsx)("ul",{children:r.map(e=>(0,l.jsxs)("li",{children:[(0,l.jsx)("span",{className:"pill pill__small",children:"camera"===e.source?"\uD83D\uDCF7":"\uD83D\uDDBC️"}),(0,l.jsx)("code",{children:e.text}),(0,l.jsx)("small",{children:new Date(e.timestamp).toLocaleTimeString()})]},e.timestamp+e.text))})]})]})]})}}}]);